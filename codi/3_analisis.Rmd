---
title: 'Debut de la  Diabetis Mellitus TIPUS 2 a Catalunya.[01.01.2008-31.12.2018] '
author: "Rai Puig & Jordi Real"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    css: logos_css/usr_styles.css
    fig_caption: yes
    toc: yes
    toc_float: yes
  pdf_document: default
  word_document:
    toc: yes
params:
   dir_dades_desti: "dades/mostra" # dades/mostra"  # dades 
   ANY: '2018'
   website: https://github.com/USR-DAPCAT/
---
&nbsp;
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
     $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"margin-left:25% ;width: 80px;\"/>')
     $head.prepend('<img src=\"logos_css/logoDAP_Cat.png\" style=\"float: left:1;width: 185px;\"/>')
   });
</script>


<div class="watermark">DRAFT</div>

****

## 0. Status:

**Aggregation windows**

&check; dt_index1:[dt_diagnostics_AP_HOSP].DM2_incusion.[window.days=c(-Inf,0)] <br/>
&check; dt_index2:[dt_facturacio].DM2_incusion.[window.days=c(-Inf,0)] <br/>
&check; dt_index3:dt_variables/filter(cod=="GLICADA") %>% filter(val>=6.5) <br/>
&check; Dm2 debut: min.date(dt_index1,dt_index2,dt_index3) <br/>
&check; Problemes de SALUT:[dt_diagnostics_AP_HOSP] [window.days=c(-Inf,0)] <br/>
&check; Facturacio:[dtagr_facturat_2018_epiTempusDM2_1] [window.days=c(-Inf,0)] <br/>
&check; Facturacio.events:[dtagr_facturat_2018_epiTempusDM2_1] [window.days=c(0,Inf)] <br/>
&check; dt_variables=dt_analitiques+dt_cliniques [window.days=c(-365,0)] <br/>
&check; dt_tabaquisme [window.days=c(-Inf,0)] <br/>



**Latest Updates   October/ 2021** 

&check;   flat table construction+ Tables of first drug billed after diagnosis of DM2    <br/>


 
**Realized**

&check;   flat table construction+ Tables of first drug billed after diagnosis of DM2    <br/>


**Pending**

&check; Revision and debugging of errors.   <br/>

# Validation phase

## Preparation Phase


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, include=F,size="huge")

gc()
# libreries i funcions
library("dplyr")
library("lubridate")
library("compareGroups")


# Descarregar funcions github -
link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)


conductor_codis<-here::here("CATALEG_PROYECTO_epitempus.xlsx")
conductor<-here::here("Conductor_PROYECTO_epitempus.xlsx")

```


```{r llegir, include = FALSE}
# Llegir plana

dades<-readRDS(here::here(params$dir_dades_desti,"dt_plana2.rds")) %>% as_tibble()


# primer filtre:

#dades<-
#dades  %>%
#  filter(entrada>="2008-01-01" & sortida<="2018-12-31") 


```

```{r recodes}


dades<-dades %>% mutate(year_inclusio=stringr::str_sub(dtindex,1,4)) 

# %>% mutate(year_inclusio=if_else(year_inclusio<=2007,"<=2007",year_inclusio))

#

#dades<-dades%>%mutate(exclusio1=DG.Exclusion)
#dades<-dades%>%mutate(exclusio2=ifelse(dtindex==sortida & situacio!="A",1,0))


```

## 1. Flow chart 
```{r Flow chart, include=T}



flow_chart1<-criteris_exclusio_diagrama(dt=dades,
                                        taulavariables=conductor,
                                        criteris = "exc_pre",
                                        ordre="exc_ordre",
                                        grups=NA,
                                        etiquetes="descripcio2",
                                        sequencial = T,
                                        pob_lab=c("epiTempus DM2  ","epiTempus DM2 without exclusions"),
                                        colors=c("white","grey"),
                                        forma=c("ellipse","box"))

flow_chart1




#Apliquem les EXCLUSIONS!
dades<-criteris_exclusio(dades,taulavariables=conductor,criteris="exc_pre")



#Apliquem que surtin els MISSINGS a les TAULES , a partir del CONDUCTOR!
#dades<-dades%>%mutate_at(extreure.variables("missings",conductor,dt=dades),as.factor)

#Etquetem  NOMS! de les  VAR  a partir del Conductor!
dades<-etiquetar(dades,taulavariables=conductor,camp_descripcio="descripcio2")





descrTable(dades)





```






## 2. Descriptive and exploratory general.
```{r resultats1, include=T}
#

formu<- formula_table1 ("Taula01",y="age8.cat",taulavariables=conductor,dt=dades)

#i) GENERAL
table1::table1(formu,
               data = dades,caption="TABLE1.General descriptive analysis",
               render.continuous=c(.="Mean (SD)", .="Median [Q1, Q3]"),render.categorical="FREQ (PCTnoNA%)",topclass="Rtable1-zebra")



```

```{r resultats2, include=T}
#

formu<- formula_table1 ("Taula02",y="age8.cat",taulavariables=conductor,dt=dades)

#i) GENERAL
table1::table1(formu,
               data = dades,caption="TABLE2.General descriptive analysis",
               render.continuous=c(.="Mean (SD)", .="Median [Q1, Q3]"),render.categorical="FREQ (PCTnoNA%)",topclass="Rtable1-zebra")



```


```{r resultats3, include=T}
#

formu<- formula_table1 ("Taula03",y="age8.cat",taulavariables=conductor,dt=dades)

#i) GENERAL
table1::table1(formu,
               data = dades,caption="TABLE3.General descriptive analysis",
               render.continuous=c(.="Mean (SD)", .="Median [Q1, Q3]"),render.categorical="FREQ (PCTnoNA%)",topclass="Rtable1-zebra")



```

```{r resultats4, include=T}
#

formu<- formula_table1 ("Taula04",y="age8.cat",taulavariables=conductor,dt=dades)

#i) GENERAL
table1::table1(formu,
               data = dades,caption="TABLE4.General descriptive analysis",
               render.continuous=c(.="Mean (SD)", .="Median [Q1, Q3]"),render.categorical="FREQ (PCTnoNA%)",topclass="Rtable1-zebra")



```

```{r resultats5, include=T}
#

formu<- formula_table1 ("Taula05",y="age8.cat",taulavariables=conductor,dt=dades)

#i) GENERAL
table1::table1(formu,
               data = dades,caption="TABLE5.General descriptive analysis",
               render.continuous=c(.="Mean (SD)", .="Median [Q1, Q3]"),render.categorical="FREQ (PCTnoNA%)",topclass="Rtable1-zebra")



```



```


## 8. ANNEX: TYPE 2 diabetes codes
```{r codis_diabetes2, include=T}

readxl::read_excel(conductor_codis,col_types = "text")%>%select(cod,AGR1,Descripcio)%>% filter(AGR1=="DM2_incusion")%>%select(cod,Descripcio)%>% knitr::kable(caption="Códigos ICD10  y  Fármacos Diabetes TIPO 2")


```


&nbsp;
<hr />
<p style="text-align: center;">A work by $Jordi Real$ $Rai Puig$ </a></p>
<p style="text-align: center;">$Llepali System$ </a></p>
<p style="text-align: center;"><span style="color: #808080;"><em><https://github.com/USR-DAPCAT/></em></span></p>



